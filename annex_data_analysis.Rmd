---
title: "Annex - Data analysis"
author: "Maria Mercedes Serra"
date: "4/29/2022"
output: 
  html_document:
      toc: yes
      toc_float: yes
      toc_depth: 4
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE,
                      message = FALSE,
                      error=TRUE)
```


```{r}
require(pacman)
p_load(tidyverse,dlookr,patchwork,skimr,kableExtra,naniar,lubridate,purrr,tidyr,
       crosstable,flextable,scales,survival,survminer,DataExplorer,performance,
       missForest,HDoutliers,caret,praznik,mRMRe,VarSelLCM,plotly,ca,factoextra,
       Rmixmod,kamila)
```



## Data


```{r}
# I load the data from csv file:
lung_data <- read.csv('data/complete_clinrad_data.csv', sep = ',') # called complete clin rad data

# I assign Patient ID to rownames to ease further work with the data
rownames(lung_data) <- lung_data$PatientID

#I remove PatientID column an additional index column not of interest as we will use rownames(patient id) to identify each entry
lung_data <- lung_data %>% select(.,-c(X,PatientID))

# I check dataframe dimensions:
dim(lung_data)

# As many clinical variables are identified as numeric when this is not the case, 
# I modify data type for specific variables of interest
# clinical T,N,M and overall stage are ordered categorical variables:
lung_data$clinical.T.Stage <- factor(lung_data$clinical.T.Stage, ordered = TRUE)
lung_data$Clinical.N.Stage <- factor(lung_data$Clinical.N.Stage, ordered = TRUE)
lung_data$Clinical.M.Stage <- factor(lung_data$Clinical.M.Stage, ordered = TRUE)
lung_data$Overall.Stage <- factor(lung_data$Overall.Stage, ordered = TRUE)

# dead status event is a binary categorical variable:
lung_data$deadstatus.event <- factor(lung_data$deadstatus.event)

# gender, histology, and manufacturer are all categorical variables also:
lung_data$gender <- factor(lung_data$gender)
lung_data$Histology <- factor(lung_data$Histology)
lung_data$Manufacturer <- factor(lung_data$Manufacturer)

# study date is a date variable, we adjust format with the help of lubridate package:
lung_data$Study.Date <- mdy(lung_data$Study.Date)

# I check resulting data structure and varnames for the modified variables:
str(lung_data[1:11])

# We can see the remaining numeric variables account for all the radiomic variables (1246)
dim(lung_data %>% keep(is.numeric) %>% select(.,-c(age,Survival.time)))
```


Main research question is weather there is an association between CT radiomic features and NSCLC histology subtype and/or with patient survival. 


I will do an initial exploratory analysis including: 


* Search for missing values
* Identify distribution of the different variables and check coherence  
* Check relationship/independency between different type of variables 
* Search for outliers


I will continue with different approaches for feature selection including:


* Features filtering for radiomic variables (exclude near cerovariance, highly correlated variables and retain variable most related with target clinical variables)
* Apply dimensionality reduction by using principal component analysis on radiomic data 


Finally I will applying model based clustering to the different reduced datasets generated in the previous points and I will analyze results by: 


* Exploring within and across cluster variable distribution 
* Compare agreement between groups generated by different reduced datasets generated in previous point
* Analyze agreement and relationship between cluster groups and the variables of interest



## Initial exploratory analysis


### Search for missing values


First I do an exploratory analysis to check for missing values in the whole data frame.


```{r}
table(is.na(lung_data))
table(is.null(lung_data))
```


We can see there are 66 missing values in total.


I generate a table that shows within the whole dataframe the variables with a list one missing value and the detail of number of missing values and its completeness rate.


```{r}
(table1 <- skim(lung_data) %>% 
   select(skim_variable,n_missing,complete_rate) %>% 
   filter(n_missing > 0) %>% 
   kable(full_with = FALSE) %>% 
   kable_classic_2()) 
table1 %>% save_kable("tables/table1.pdf")
```



I generate visual representations of single and joint missing values using `gg_miss_upset` function from `naniar` package.


```{r}
tiff(filename = "figures/Fig1.tiff", width = 200, height = 150, units = "mm", res = 300)
gg_miss_upset(lung_data %>% select_if(~ any(is.na(.)))) 
fig <- dev.off()
gg_miss_upset(lung_data %>% select_if(~ any(is.na(.))))
```


Overall completeness rate was superior to 0.9 for every variable. Histology is our response variable for our first research question so observations without a value for histology variable will be fully excluded. In addition as a subgroup of NSCLC not otherwise specified (nos) is available within the histology categories it is not clear if NA cases have in effect the confirmation of NSCLC diagnosis at all; so it makes sense to exclude this cases.



```{r}
lung_data_complete <- lung_data %>% drop_na(Histology)
dim(lung_data_complete)
```


After excluding every row with missing histology value, we end up with 379 observations.
On the contrary we might imput missing values affecting other variables to avoid missing additional observations that may be usefull, but I will continue with imputation after evaluation data distribution,  and data coherence to check if any additional values should be considered as missing and which imputation technique might be pertinent to use.



### Identify distribution of the different variables and check coherence 


I verify general statistical summary and distribution of features.


First for study dates:


```{r}
lung_data_complete %>% select(Study.Date) %>% skim()
```


Then I get summary statistics for factor variables:


```{r}
(table2a <- lung_data_complete %>% 
    select(Histology,gender,deadstatus.event,Manufacturer) %>% 
    univar_category() %>% 
    kable(full_with = FALSE) %>% kable_classic())
table2a %>% save_kable("tables/table2a.pdf")
(table2b <- lung_data_complete %>% 
    select(Overall.Stage,clinical.T.Stage,Clinical.N.Stage,Clinical.M.Stage) %>% 
    univar_category() %>% 
    kable(full_with = FALSE) %>% kable_classic())
table2b %>% save_kable("tables/table2b.pdf")
```


I represent factor variables with barplots to visualize data distribution and clases available for each categorical variable:


```{r}
lung_data_complete %>%
  keep(is.factor) %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_bar()+
    scale_y_continuous( limits = c(0,400)) +
    geom_text(stat='count', aes(label=..count..), vjust=-0.1, size = 3)
ggsave("figures/Fig2.tiff",width = 174, height = 130, device="tiff", dpi=300, units = "mm", scale = 1)
```


We can see from the Overall.Stage variable distribution, that stage IV is not represented in this dataset so we will center analysis mainly on this groups of non-metastatic disease patients. There seems to be some isolated incoherent, erroneous registries regarding clinical T, N and M categories. Possible values for clinical.T.Stage category in lung cancer range from T1 to T4, and as we can see there are few cases with T == 5. Same happens with Clinical.N.Stage == 4 and we also find some cases with Clinical M Stage == 3 that do not exists either within this classicifcation. Specific incoherent cases are enumerated in tables 5.3, 5.4, 5.5 respectively.



```{r}
(table3 <- lung_data_complete %>% 
  filter(clinical.T.Stage ==5) %>% select(clinical.T.Stage,Overall.Stage)  %>% 
  kable(full_with = FALSE) %>% 
  kable_classic_2())
table3 %>% save_kable("tables/table3.pdf")
```


```{r}
(table4 <- lung_data_complete %>% 
  filter(Clinical.N.Stage ==4) %>% select(Clinical.N.Stage,Overall.Stage) %>% 
  kable(full_with = FALSE) %>% 
  kable_classic_2())
table4 %>% save_kable("tables/table4.pdf")
```



```{r}
(table5 <- lung_data_complete %>% filter(Clinical.M.Stage ==3) %>% 
  select(Clinical.M.Stage,Overall.Stage) %>% 
  kable(full_with = FALSE) %>% 
  kable_classic_2()) 
table5 %>% save_kable("tables/table5.pdf")
```



These are interpreted as erroneous so missing values are assigned to replace these entries as well as for plastimatch manufacturer. This will be then handled along with missing values imputation.


```{r}
# I assign na values to erroneous entries and drop unused levels:
lung_data_complete <- lung_data_complete %>% replace_with_na(
  replace = list(clinical.T.Stage = 5,
                 Clinical.N.Stage = 4,
                 Clinical.M.Stage = 3,
                 Manufacturer = 'Plastimatch')) %>%
  droplevels.data.frame()
```



We can see now the joint missing patterns after removing observations with histology missing values and imputing with missing values the incoherent clinical T/N/M entries:


```{r}
tiff(filename = "figures/Fig3.tiff", width = 200, height = 150, units = "mm", res = 300)
gg_miss_upset(lung_data_complete %>% select_if(~ any(is.na(.)))) 
fig <- dev.off()
gg_miss_upset(lung_data_complete %>% select_if(~ any(is.na(.))))
```



Now I continue with the summary statistics for numeric clinical numeric variables: 


```{r}
(table6 <- lung_data_complete %>% 
  select(age,Survival.time) %>% 
  describe() %>%
  select(described_variables,n,na,mean,sd,se_mean,IQR,skewness,kurtosis) %>% 
  kable(full_with = FALSE) %>% kable_classic_2()) 
table6 %>% save_kable("tables/table6.pdf")
```


And generate histograms to better visualize distributions:


- First for the remaining clinical variables:


```{r}
g1 <- ggplot(lung_data_complete,aes(age)) + 
  geom_histogram(alpha = .8) +
  theme_bw() 
g2 <- ggplot(lung_data_complete,aes(Survival.time)) + 
  geom_histogram(alpha = .8) +
  theme_bw()
(g1 + g2)
ggsave("figures/Fig4.tiff",width = 174, height = 100, device="tiff", dpi=300, units = "mm", scale = 1)
```


- As we have 1246 radiomic variables, I'll continue exploring clinical and main study info first, and continue with radiomics exploratory analysis while and after performing variable selection



### Check relationship/independency between different type of variables


First as my first research question is weather radiomic variables are related with histology class or not, I want to check histology is independent from other clinical variables and manufacturer of the scanner used to do the exam. 



```{r}
g1 <- ggplot(lung_data_complete,aes(age, fill = Histology)) + 
  geom_boxplot(alpha = .5) +
  coord_flip() +
  theme_bw() +
  theme(legend.position = 'none')

g2 <- ggplot(lung_data_complete,aes(gender, fill = Histology)) + 
  geom_bar(position = 'dodge',alpha = .5) +
  theme_bw() +
  theme(legend.position = 'none')

g3 <- ggplot(lung_data_complete,aes(Overall.Stage, fill = Histology)) + 
  geom_bar(position = 'dodge',alpha = .5) +
  theme_bw() 

g4 <- ggplot(lung_data_complete,aes(Manufacturer, fill = Histology)) + 
  geom_bar(position = 'dodge',alpha = .5) +
  theme_bw() 

(g1 + g2)/(g3 + g4) + plot_layout(guides = "collect") 
ggsave("figures/Fig5.tiff",width = 174, height = 100, device="tiff", dpi=300, units = "mm", scale = 1)
```


I check the relationship between categorical variables with main variables of interest. I use `crosstable` package to ease table construction and automatic test to search for independency.


```{r}
(table7 <- crosstable(lung_data_complete, c(age, gender, Overall.Stage, Manufacturer), 
           by = Histology, test = TRUE) %>% as_flextable() %>% autofit()) 
 table7 %>% save_as_image("tables/table7.png")

(table8 <- crosstable(lung_data_complete, c(age, gender, Manufacturer), 
           by = Overall.Stage, test = TRUE) %>% as_flextable() %>% autofit())
table8 %>% save_as_image("tables/table8.png")
```



In this tables we can easily see how gender and histology, and manufacturer and histology are independent. On the contrary, there seems to be some relationship between histology group and age, as well as between histology and overall stage. In this case it seems specially important to verify the relationship of these variables with any clustering model generated as these could bias interpretation of clustering association to target histology variable.



I continue verifying the relationship between ordinal variables using Spearman correlation coeficient 


```{r}
(table9 <- lung_data_complete %>% 
  select(Overall.Stage,clinical.T.Stage) %>% 
  drop_na(Overall.Stage,clinical.T.Stage) %>% 
  table()%>%
  addmargins() %>% 
  kable(full_with = FALSE) %>% kable_classic_2() %>%  
  add_header_above(c("Overall.Stage" = 1, "Clinical.T.Stage" = 5)) )
table9 %>% save_kable("tables/table9.pdf")
cor(as.integer(lung_data_complete$clinical.T.Stage),
    as.integer(lung_data_complete$Overall.Stage),
    method = 'spearman',
    use = 'complete.obs')
```



```{r}
(table10 <- lung_data_complete %>% 
  select(Overall.Stage,Clinical.N.Stage) %>% 
  drop_na(Overall.Stage,Clinical.N.Stage) %>% 
  table()%>%
  addmargins() %>% 
  kable(full_width = FALSE) %>% 
  kable_classic_2() %>%  
  add_header_above(c("Overall.Stage" = 1, "Clinical.N.Stage" = 5))) 
table10 %>% save_kable("tables/table10.pdf")
cor(as.integer(lung_data_complete$Clinical.N.Stage),
        as.integer(lung_data_complete$Overall.Stage),
        method = 'spearman',
        use = 'complete.obs')

```



```{r}
(table11 <- lung_data_complete %>% 
  select(clinical.T.Stage,Clinical.N.Stage) %>% 
  drop_na(clinical.T.Stage,Clinical.N.Stage) %>% 
  table()%>%
  addmargins() %>% 
  kable(full_width = FALSE) %>% 
  kable_classic_2() %>%  
  add_header_above(c("Clinical.T.Stage" = 1, "Clinical.N.Stage" = 5))) 
table11 %>% save_kable("tables/table11.pdf")
cor(as.integer(lung_data_complete$Clinical.N.Stage),
    as.integer(lung_data_complete$clinical.T.Stage),
    method = 'spearman',
    use = 'complete.obs')
```


As expected we see there is some degree of correlation between Overall Stage and T and N clinical categories. On the contrary T and N categories do not show a high degree of correlation.


I check the distribution of different histology classes along study dates to check if there might be any suggestion of potential batch bias.


```{r}
lung_data_complete$Study.Date <- as.POSIXct(lung_data_complete$Study.Date)
ggplot(lung_data_complete, aes(Study.Date, ..count.., fill = Histology)) + 
    geom_histogram(alpha = .5) +
    theme_bw() + xlab(NULL) +
    scale_x_datetime(breaks = date_breaks("3 months"),
                     labels = date_format("%Y-%b")) +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
ggsave("figures/Fig6.tiff",width = 174, height = 100, device="tiff", dpi=300, units = "mm", scale = 1)

```


Regarding the period of time during which studies were performed, we see all classes seem pretty much represented along the years in favor of avoiding specific technique batch biases. 



Now I want to check if there is a relationship between survival and main categorical classes. To do so I will use `Survival` and `survminer` R packages to construct Kaplan Meyer plots using Survival.time and deadstatus.event variables and compare mean survival between different classes.


```{r}
tiff(filename = "figures/Fig7.tiff", width = 300, height = 200, units = "mm", res = 300)
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Histology, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           tables.height = 0.2)
fig <- dev.off()
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Histology, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           tables.height = 0.2)
```



```{r}
tiff(filename = "figures/Fig8.tiff", width = 300, height = 200, units = "mm", res = 300)
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Overall.Stage, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           tables.height = 0.2)
fig <- dev.off()
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Overall.Stage, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           tables.height = 0.2)
```



```{r}
tiff(filename = "figures/Fig9.tiff", width = 300, height = 200, units = "mm", res = 300)
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ gender, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
            tables.height = 0.2)
fig <- dev.off()
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ gender, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
            tables.height = 0.2)
```



```{r}
tiff(filename = "figures/Fig10.tiff", width = 300, height = 200, units = "mm", res = 300)
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Manufacturer, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
            tables.height = 0.2)
fig <- dev.off()
ggsurvplot(survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ Manufacturer, data = lung_data_complete), 
           conf.int=TRUE, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
            tables.height = 0.2)
```


While there is no significant relationship between Survival and Histology, Survival and Overall Stage, and Survival and Gender; there is a finding of major importance here regarding observations corresponding to scanners from different Manufacturer. This could add a major bias to the model so we have to exclude any radiomic features related to scanner Manufacturer to make sure to remove any bias from this source.



#### Relationship between radiomic numeric variables 


As there are so many continuous radiomic variables I will just check for the moment their pearson correlation coefficient and represent this with heatmap. After performing variable selection I will further analyze radiomic variables distribution and relationship with other clinical variables.



```{r, fig.width=8, fig.height=8}
radiomic_vars <- lung_data_complete %>% keep(is.numeric) %>%
  select(.,-c(age,Survival.time))
plot_correlation(radiomic_vars, type = "c", theme_config = list("legend.position" = "bottom","axis.text.x" = element_blank(), "axis.text.y" = element_blank()))
ggsave("figures/Fig11.tiff",width = 200, height = 200, device="tiff", dpi=300, units = "mm", scale = 1)
```


Now I will perform a Shapiro Wilk test to formaly evaluate normality for every numeric variable available in current data frame:


```{r}
# I apply shapiro wilk test to every numeric value in the data frame
shap <- lung_data_complete %>% 
  keep(is.numeric) %>% 
  apply(.,2,shapiro.test) 

# I define a vector with a boolean stating if p value is greater than corrected 0.05
shapres <- sapply(shap, function(x) x$p.value > .05/length(shap))
table(shapres)
```


When exploring numerical variable distribution we could already see many variables with an assymetric distribution mostly non-normally distributed variables. We will take this into account when selecting  outlier detection techniques and imputation techniques both for outliers and missing values.




### Search for outliers


#### Univariate outlier detection:

Univariate oulier detection with IQR + 1.5 criteria. If we just check in univariate manner, we can see almost every observation has at least one value corresponding to an outlier in at least one variable.


```{r}
check_outliers(lung_data_complete, method = "iqr")
```

 
 
#### Multivariate outlier detection:


To perform outlier detection I will use `HDoutliers` package that allows performing multivariate outlier detection for mixed data. To be able to work with this algorithm I need to perform imputation of missing values first so I will use `missForest` package that gives me the possibility to perform missing value imputation, again taking in account the mixed data types we are dealing with.


##### Pre-processing step: missing values imputation


I perform missing values imputation first:


```{r}
lung_data.imp <- missForest(lung_data_complete %>% select(.,-Study.Date))

#check imputation error. NRMSE is normalized mean squared error. It is used to represent error derived 
# from imputing continuous values. PFC (proportion of falsely classified) is used to represent error 
# derived from imputing categorical values.
lung_data.imp$OOBerror

#check new values
lung_data.imp$ximp[rownames(lung_data.imp$ximp) %in% rownames(which(is.na(lung_data_complete), arr.ind=TRUE)),] %>% select(age,gender,clinical.T.Stage,Clinical.N.Stage,Clinical.M.Stage,Overall.Stage,deadstatus.event,Manufacturer)

# we can see now M stage is in fact 0 for every entry, so we will remove this column
table(lung_data.imp$ximp$Clinical.M.Stage)

# I remove Clinical M Stage from the dataset and I add Study Date again
lung_data_naimp <- lung_data.imp$ximp %>% select(.,-Clinical.M.Stage) 
```



##### Multivariate outlier detection:


```{r}
# Transforms the data according to the specifications in Wilkinson’s hdoutliers algorithm replaces each categorical variables with a numeric variable corresponding to its first component in multiple correspondence analysis, then maps the data to the unit square

lung_data.trans <- dataTrans(lung_data_naimp)

# Implements the first stage of the hdoutliers Algorithm, in which the data is partitioned according to exemplars and their associated lists of members.

lung_data.mem <- getHDmembers(lung_data.trans)

# An exponential distribution is fitted to the upper tail of the nearest-neighbor distances between
# exemplars (the observations considered representatives of each component of member

lung_data.out <- getHDoutliers(lung_data.trans, lung_data.mem, alpha = 0.05)

# Produces a plot of the data (transformed according to the Wilkinson’s specifications) showing the
# outliers. If the data has more than two dimensions, it is plotted onto the principal components of
# the data that remains after removing outliers.

tiff(filename = "figures/Fig12.tiff", width = 200, height = 150, units = "mm", res = 300)
plotHDoutliers(lung_data_naimp,lung_data.out)
fig <- dev.off()
plotHDoutliers(lung_data_naimp,lung_data.out)

# we identify the specific observations classified as outliers:
rownames(lung_data.trans)[c(lung_data.out)]
```


When taking in account all the categorical and numerical variables available on the data set, excluding dates,  2 particular observations are considered outliers, "LUNG1-027" and "LUNG1-069". Extreme values for a single variable seem to make more sense when they are explained by other variables.


I remove the outliers detected:


```{r}
# I add study date variable again to the update data set
lung_data_no_na <- lung_data_naimp %>% cbind(Study.Date = lung_data_complete$Study.Date)
lung_data_no_out <- lung_data_no_na[-c(which(rownames(lung_data_no_na) %in% rownames(lung_data.trans)[c(lung_data.out)])),]
dim(lung_data_no_out)
```



## Feature selection for radiomic variables


```{r}
# I build a dataframe just with the radiomic features:
radiomic_vars <- lung_data_no_out %>% keep(is.numeric) %>%
  select(.,-c(age,Survival.time))
```


### Removing near cero variance features


To check for near zero variance variables I use `nearZeroVar` fuction from `caret` package.


```{r}
names(radiomic_vars)[nearZeroVar(radiomic_vars)]
```


No near 0 variance variables


### First approach: MRMR


I first use maximum relevance minimum redundance algorithm. As there are so many radiomic features, I want to be sure I preserve most relevant features for the classes of interest while filtering redundant variables. To do so I use `MRMR` function from `praznik` package, and `mRMR.classic` function from `mRMRe` package.


```{r, fig.width=8, fig.height=8}
# I first select MRMR features taking in account histology class:
select1 <- MRMR(radiomic_vars,lung_data_no_out$Histology,k = 20)
names(select1$selection)

# Then I do the same for the survival target interest
df <- as.data.frame(radiomic_vars %>% cbind(surv1 = Surv(lung_data_no_out$Survival.time, lung_data_no_out$deadstatus.event)))
df$original_shape_VoxelVolume <- as.numeric(df$original_shape_VoxelVolume)
dd <- mRMR.data(data = df)
select2 <- mRMR.classic(data = dd, target_indices = c(grep("surv1", colnames(df))), feature_count = 20)
selected2_features <- select2@feature_names[solutions(select2)$'1247'[,1]]
selected2_features

# I check variables matching for both vectors of selected variables
intersect(names(select1$selection),selected2_features)


# Still keep all the variables selected for at least one class taking in account a variable might be highly related to histology class for example and not to survival and so on
mrmr_radiomics <- radiomic_vars %>% dplyr::select(names(select1$selection),all_of(selected2_features))

plot_correlation(mrmr_radiomics, type = "c", theme_config = list(legend.position = "bottom", axis.text.x = element_text(angle =
    90, size = 9), axis.text.y = element_text(size = 9)))

ggsave("figures/Fig13.tiff",width = 260, height = 260, device="tiff", dpi=300, units = "mm", scale = 1)

dim(mrmr_radiomics)
```


We can see `dim(mrmr_radiomics)[2]` radiomic features were selected taking in account some minimal overlap between both MRMR selections regarding histology or survival.


Then I eliminate still highly redundant variables using `findCorrelation` function from `caret` package.


```{r, fig.width=8, fig.height=8}
# As after MRMR I still have blocks of highly correlated variables I add an additional simple correlation filter to eliminate those still highly correlated:
redundant_vars <- findCorrelation(
  cor(mrmr_radiomics),
  cutoff = 0.90,
  names = TRUE
)
filtered_radiomics <- mrmr_radiomics %>% dplyr::select(.,-all_of(redundant_vars))
plot_correlation(filtered_radiomics, type = "c")

ggsave("figures/Fig14.tiff",width = 250, height = 250, device="tiff", dpi=300, units = "mm", scale = 1)

dim(filtered_radiomics)
```


We are now left with `dim(filtered_radiomics)[2]` radiomic features.


Now that we have a few selected features, I can deepen radiomic feature description missing on initial global analysis. 


### Selected radiomic features univariate distribution


```{r}
(table12 <- filtered_radiomics %>% skim() %>% 
  select(.,-c(skim_type,n_missing,complete_rate, numeric.hist)) %>% 
  kable(full_with = FALSE) %>% kable_classic_2()) 
table12 %>% save_kable("tables/table12.pdf")
```


In this table we can see summary statistics for selected radiomic features, we can see many of these include negative values, somthing to take into account when evaluating data transformation.


I further represent univariate distribution by representing data with histograms:


```{r, fig.width=8, fig.height=10}
filtered_radiomics %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free", ncol = 4) +
    geom_histogram() +
    theme(strip.text.x = element_text(size = 6))
ggsave("figures/Fig15.tiff",width = 300, height = 300, device="tiff", dpi=300, units = "mm", scale = 1)
```


And I further evaluate normality by generating qqplot for these selected features.


```{r, fig.width=8, fig.height=10}
filtered_radiomics %>% 
  gather() %>% 
  ggplot(aes(sample=value)) +
    facet_wrap(~ key, scales = "free", ncol = 4) +
    stat_qq() +
    theme(strip.text.x = element_text(size = 6))
ggsave("figures/Fig16.tiff",width = 300, height = 300, device="tiff", dpi=300, units = "mm", scale = 1)
```


As previously evaluated for the whole dataset with Shapiro Wilk test, we see in both histograms and qqplots that many radiomic variables deviate from normality and have a rather skewed distribution. We should take this into account as data transformation may be needed for optimal performance of different model-based cluster models. 


As we have mainly positive skewed distributions I will apply a log transform after adding a mimimum value to avoid negative and ease optimization of different models.



```{r, fig.width=8, fig.height=10}
min(filtered_radiomics)
log_filtered_radiomics <- filtered_radiomics %>%
  lapply(function(x){log(x+5503)}) %>% 
  as.data.frame()

log_filtered_radiomics %>% 
  gather() %>% 
  ggplot(aes(sample=value)) +
    facet_wrap(~ key, scales = "free", ncol = 4) +
    stat_qq() +
    theme(strip.text.x = element_text(size = 6))
ggsave("figures/Fig17.tiff",width = 300, height = 300, device="tiff", dpi=300, units = "mm", scale = 1)
```


As we can see in the histogram plots still a lot of variables seem to present extreme outliers, I will evaluate this again now with selected variables in order to define if further observations should be excluded to optimize data modeling.


```{r}
lung_data_filtered_radiomics <- cbind(lung_data_no_out %>%
                                        dplyr::select(.,-c(starts_with('original'),
                                                    starts_with('wavelet'),
                                                    starts_with('log'),
                                                    Study.Date)),
                                      log_filtered_radiomics)

out <- HDoutliers(lung_data_filtered_radiomics)
plotHDoutliers(lung_data_filtered_radiomics,out)
```


No additional multivariate outliers are detected when relating all the variables.


### Selected radiomic features relationship/independency with main variables clinical and dicom variables


We continue with evaluation of selected radiomic feature relationship to pertinent clinical and dicom variables. First I generate boxplots to represent radiomic feature distribution for the different histology classes.


```{r, fig.width=8, fig.height=10}
plot_boxplot(log_filtered_radiomics %>% 
               cbind(Histology = lung_data_no_out$Histology)
             , by = "Histology",
             ncol = 5,
             nrow = 7)+
    theme(strip.text.x = element_text(size = 1))
ggsave("figures/Fig18.tiff",width = 500, height = 500, device="tiff", dpi=300, units = "mm", scale = 1)
```


I then evaluate mean and standard deviation of radiomic features within each class and test to verify if any of this relationships might be significant.


```{r}
radiomics_hist <- log_filtered_radiomics %>% cbind(Histology = lung_data_no_out$Histology)
crostab <- crosstable(num_digits = 3,radiomics_hist, c(colnames(radiomics_hist %>% dplyr::select(.,-Histology))), by = Histology, test = TRUE) 

(table13 <- crostab %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable == 'Mean (std)') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table13 %>% save_kable('tables/table13.pdf')

```



Now I will evaluate potential relationship between individual radiomic features and survival. To do so I adjust a cox model for each one.


```{r}
radiomics_surv <- log_filtered_radiomics %>% cbind(Survival.time = lung_data_no_out$Survival.time, deadstatus.event = lung_data_no_out$deadstatus.event) 

surv_formulas <- sapply(colnames(log_filtered_radiomics),function(x) as.formula(paste('Surv(Survival.time,as.numeric(deadstatus.event))~', x)))
surv_models <- lapply(surv_formulas, function(x){coxph(x, data = radiomics_surv)})

surv_rad_vars <- lapply(surv_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-format(signif(x$wald["pvalue"], digits=2),scientific = FALSE)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          res<-c(beta, wald.test, p.value)
                          names(res)<-c("beta", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res <- t(as.data.frame(surv_rad_vars, check.names = FALSE))
(table14 <- as.data.frame(res) %>% arrange(p.value) %>% 
  kable(full_with = FALSE) %>% kable_classic_2())
table14 %>% save_kable('tables/table14.pdf')
```



It is also important to evaluate the possible relationship between selected radiomic features and scanner manufacturer.


```{r, fig.width=8, fig.height=10}
plot_boxplot(log_filtered_radiomics %>% 
               cbind(Manufacturer = lung_data_no_out$Manufacturer)
             , by = "Manufacturer",
             ncol = 5,
             nrow = 7)+
    theme(strip.text.x = element_text(size = 1))
ggsave("figures/Fig19.tiff",width = 500, height = 500, device="tiff", dpi=300, units = "mm", scale = 1)

radiomics_manuf <- log_filtered_radiomics %>% cbind(Manufacturer = lung_data_no_out$Manufacturer)
crostab <- crosstable(num_digits = 3,radiomics_manuf, c(colnames(radiomics_manuf  %>% dplyr::select(.,-Manufacturer))), by = Manufacturer, test = TRUE) 

manuf_rad_vars <- crostab %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable == 'Mean (std)') %>% 
            dplyr::select(.,-c(string,.id))
(table15 <- manuf_rad_vars %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table15 %>% save_kable('tables/table15.pdf')
```


Seems pertinent to exclude from the model those features that seem highly correlated to scanner manufacturer, as this could add additional bias to the model. I will not correct alfa as I prefer to be sure to exclude any possibly related feature.


```{r}
out_manuf_vars <- manuf_rad_vars %>%
  separate(pval,into = c('pval'),sep = "<",convert = TRUE) %>% 
  filter(pval < 0.05) 

log_filtered_stable_radiomics <- log_filtered_radiomics %>% select(.,-c(out_manuf_vars$label))
```


I will still have to use Manufacturer variable in the model, given the previous proven lack of independence with mean survival. 


We are now left with `r dim(log_filtered_stable_radiomics)[2]` radiomic features.



### Second option PCA dimensionality reduction


As a second option I will try reducing dimensionality using PCA, an unsupervised approach.

I remove first highly correlated variables to ease further PCA analysis. 


```{r}
# I eliminate blocks of highly correlated variables by using a simple correlation filter to eliminate those still highly correlated:
redundant_vars <- findCorrelation(
  cor(radiomic_vars),
  cutoff = 0.95,
  names = TRUE
)
non_redund_radiomics <- radiomic_vars %>% select(.,-all_of(redundant_vars))
dim(non_redund_radiomics)
```


Given the known skewed distribution of radiomic vars and negative values I will also transform data before performing PCA.


```{r}
min(non_redund_radiomics)
log_non_redund_radiomics <- non_redund_radiomics %>%
  lapply(function(x){log(x+1963908)}) %>% 
  as.data.frame()
```


To perform PCA I will use `prcomp` function from R `stats` package. I continue with PCA where I will select the 40 first components to work with. I will also scale data for PCA analysis to avoid the different weights coming from the difference in scale of each radiomics variable.


```{r}
pca_radiomics <- prcomp(log_non_redund_radiomics, scale = TRUE)
pca_rad <- pca_radiomics$x[,1:40]

pca_radiomics$rotation[1:10,1:10]
```


When evaluating the weights we can see most radiomic features applied to the original images contributed the most to first PCA components, much different to what we found as relevant when filtering variables with MRMR method


I evaluate the relationship of the different components to the variables of interest:



```{r, fig.width=8, fig.height=10}

plot_boxplot(as.data.frame(pca_rad) %>% 
               cbind(Histology = lung_data_no_out$Histology)
             , by = "Histology",
             ncol = 5,
             nrow = 7)+
    theme(strip.text.x = element_text(size = 1))
ggsave("figures/Fig20.tiff",width = 500, height = 500, device="tiff", dpi=300, units = "mm", scale = 1)


sum_pca <- summary(pca_radiomics)

pca_radiomics_hist <- as.data.frame(pca_rad) %>% cbind(Histology = lung_data_no_out$Histology)
crostab <- crosstable(num_digits = 3,pca_radiomics_hist, c(colnames(pca_radiomics_hist %>% select(.,-Histology))), by = Histology, test = TRUE) 

(table16 <- crostab %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable == 'Mean (std)') %>% 
            select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table16 %>% save_kable('tables/table16.pdf')
```



```{r}
radiomics_pca_surv <- as.data.frame(pca_rad) %>% cbind(Survival.time = lung_data_no_out$Survival.time, deadstatus.event = lung_data_no_out$deadstatus.event) 


surv_formulas <- sapply(colnames(as.data.frame(pca_rad)),function(x) as.formula(paste('Surv(Survival.time,as.numeric(deadstatus.event))~', x)))
surv_models <- lapply(surv_formulas, function(x){coxph(x, data = radiomics_pca_surv)})

surv_rad_pca_vars <- lapply(surv_models,
                       function(x){ 
                          x <- summary(x)
                          p.value<-format(signif(x$wald["pvalue"], digits=2),scientific = FALSE)
                          wald.test<-signif(x$wald["test"], digits=2)
                          beta<-signif(x$coef[1], digits=2);#coeficient beta
                          res<-c(beta, wald.test, p.value)
                          names(res)<-c("beta", "wald.test", 
                                        "p.value")
                          return(res)
                          #return(exp(cbind(coef(x),confint(x))))
                         })
res_pca <- t(as.data.frame(surv_rad_pca_vars, check.names = FALSE))
(table17 <- as.data.frame(res_pca) %>% arrange(p.value) %>% kable(full_with = FALSE) %>% kable_classic_2() )
table17 %>% save_kable('tables/table17.pdf')
```


```{r, fig.width=8, fig.height=10}
plot_boxplot(as.data.frame(pca_rad) %>% 
               cbind(Manufacturer = lung_data_no_out$Manufacturer)
             , by = "Manufacturer",
             ncol = 5,
             nrow = 7)+
    theme(strip.text.x = element_text(size = 1))
ggsave("figures/Fig21.tiff",width = 500, height = 500, device="tiff", dpi=300, units = "mm", scale = 1)

radiomics_manuf <- as.data.frame(pca_rad) %>% cbind(Manufacturer = lung_data_no_out$Manufacturer)
crostab <- crosstable(num_digits = 3,radiomics_manuf, c(colnames(radiomics_manuf  %>% dplyr::select(.,-Manufacturer))), by = Manufacturer, test = TRUE) 

manuf_rad_vars <- crostab %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable == 'Mean (std)') %>% 
            dplyr::select(.,-c(string,.id))
(table18 <- manuf_rad_vars %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table18 %>% save_kable('tables/table18.pdf')
```


Though fewer, we can see also some principal components related to Manufacturer model. I will also exclude these to avoid additional bias. I will not correct alfa as I prefer to be sure to exclude any possibly related feature.


```{r}
out_manuf_vars <- manuf_rad_vars %>%
  separate(pval,into = c('pval'),sep = "<",convert = TRUE) %>% 
  filter(pval < 0.05) 

pca_stable_radiomics <- as.data.frame(pca_rad) %>% select(.,-c(out_manuf_vars$label))
```



### Construction of final datasets


I construct both filtered and pca datasets to be able to compare results. I exclude from the datasets the considered 'target variables' including mainly Histology and both components of survival estimates (Survival.time and deadstatus.event). In addition I exclude Study date as clustering models don't accept this kind of data. Regarding stage I leave only Overall.Stage variable as main representative variable for stage, and to avoid redundancy with clinical T and N stages. As we previously cleared variables related to scanner manufacturer, I will leave it out of the model as well, to avoid potential bias in clustering given its accidental relationship with mean survival.



```{r}
lung_data_filtered_radiomics <- cbind(lung_data_no_out %>%
                                        dplyr::select(.,-c(starts_with('original'),
                                                    starts_with('wavelet'),
                                                    starts_with('log'),
                                                    Histology,
                                                    deadstatus.event,
                                                    Survival.time,
                                                    Study.Date,
                                                    clinical.T.Stage,
                                                    Clinical.N.Stage,
                                                    Manufacturer)),
                                      log_filtered_radiomics)
(table19 <- describe(lung_data_filtered_radiomics) %>% 
    select(described_variables,mean,sd,skewness,kurtosis,p00,p100,IQR) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table19 %>% save_kable('tables/table19.pdf')
```


As we can see value ranges differ significantly between numerical variables (radiomics and age included) this could bias the weight of each variable when contributing to the model so it is recomended to have all variables in the same scale. I chose to use min-max scaling. Then categorical variables will be directly treated by VarCellCM. 



```{r}
filtered_cont_scaled <- lung_data_filtered_radiomics %>% keep(is.numeric) %>% 
  lapply(function(x){(x - min(x)) / (max(x) - min(x))}) %>% as.data.frame()

lung_data_filtered_scaled_radiomics <- lung_data_filtered_radiomics %>% 
  keep(is.factor) %>%
  cbind(filtered_cont_scaled)

(table20 <- describe(lung_data_filtered_scaled_radiomics) %>% 
    select(described_variables,mean,sd,skewness,kurtosis,p00,p100,IQR) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table20 %>% save_kable('tables/table20.pdf')
```



Now I construct the same dataset but including previously selected PCA radiomics. 


```{r}
lung_data_pca_radiomics <- cbind(lung_data_no_out %>%
                                        dplyr::select(.,-c(starts_with('original'),
                                                    starts_with('wavelet'),
                                                    starts_with('log'),
                                                    Histology,
                                                    deadstatus.event,
                                                    Survival.time,
                                                    Study.Date,
                                                    clinical.T.Stage,
                                                    Clinical.N.Stage,
                                                    Manufacturer)),
                                      pca_rad)
(table21 <- describe(lung_data_pca_radiomics) %>% 
    select(described_variables,mean,sd,skewness,kurtosis,p00,p100,IQR) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table21 %>% save_kable('tables/table21.pdf')
```


I will repeat the min-max scaling with PCA dataset to be sure all continuous variables have the same range of values.


```{r}
pca_cont_scaled <- lung_data_pca_radiomics %>% keep(is.numeric) %>% 
  lapply(function(x){(x - min(x)) / (max(x) - min(x))}) %>% as.data.frame()

lung_data_pca_scaled_radiomics <- lung_data_pca_radiomics %>% 
  keep(is.factor) %>%
  cbind(pca_cont_scaled)

(table22 <- describe(lung_data_pca_scaled_radiomics) %>% 
    select(described_variables,mean,sd,skewness,kurtosis,p00,p100,IQR) %>% kable(full_with = FALSE) %>% kable_classic_2()) 
table22 %>% save_kable('tables/table22.pdf')
```



## Clustering


### Clustering mixed data with VarCellCM 


#### With varsel variable selection


##### Data MRMR filtered Radiomics


First I will generate a model based clustering model using the MRMR filtered radiomics dataset with the added clinical variables and scaling done in previous points. I generate the model using `VarSelCluster` function from `VarSelCM` package, using variable selection. I display main discriminative variables given the model adjustment and clusters in 3D scatter plot using these variables as main axes for the representation. I also display the uncertainty probability for each cluster.


```{r, fig.width=8, fig.height=6}
# I adjust VarSelCluster model without variables selection for this first
# approach and using BIC criteria to estimate the optimal number of clusters
set.seed(12345)
res_varsel <- VarSelCluster(x = lung_data_filtered_scaled_radiomics,
                          gvals = 2:10, 
                          nbcores = 4, 
                          vbleSelec = TRUE,  
                          crit.varsel = "BIC")

# I check the resulting model summary
summary(res_varsel)
res_varsel@model@names.relevant
res_varsel@model@names.irrelevant

# I check the discriminative power of the variables 
tiff(filename = "figures/Fig22.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel)
fig <- dev.off()
plot(res_varsel)


# I build q data frame including partitions, variables used in the model and other variables of interest
lung_data_res_varsel <- lung_data_filtered_scaled_radiomics %>% 
                              cbind(lung_data_no_out %>% select(Histology,
                                                                Survival.time,
                                                                deadstatus.event,
                                                                Manufacturer),
                                    partition = as.factor(res_varsel@partitions@zMAP))


# I generate a representation of the clusters using the main discriminative variables to define the axes
# (screencapture saved as figure 23)
plot_ly(lung_data_res_varsel, x=~original_shape_VoxelVolume, y=~wavelet.HLL_glszm_LargeAreaHighGrayLevelEmphasis,
        z=~wavelet.HHH_glszm_LargeAreaLowGrayLevelEmphasis, color=~partition) %>%
        add_markers(size=1.5)%>%
        layout(
          scene = list(
            xaxis = list(size = 0.5),
            yaxis = list(size = 0.5),
            zaxis = list(size = 0.5)))


# I display a summary of the probabilities of missclassification for each cluster
tiff(filename = "figures/Fig24.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel, type="probs-class")
fig <- dev.off()
plot(res_varsel, type="probs-class")
```


Then I want to evaluate possible relationship between clusters generated and histology class.


```{r}
# I generate a cross table to check distribution of histology classes with partitions
table_hist_clust_res_varsel <- table(lung_data_res_varsel$Histology,lung_data_res_varsel$partition)
addmargins(table_hist_clust_res_varsel)

# I evaluate general association between clusters and histology class using chi 2 test
chisq.test(table_hist_clust_res_varsel) 


# I display distribution of histology class within different clusters
ggplot(lung_data_res_varsel,aes(partition, fill = Histology)) + 
  geom_bar(position = 'fill',alpha = .5) +
  coord_flip()+
  theme_bw() 
ggsave("figures/Fig25.tiff",width = 100, height = 50, device="tiff", dpi=300, units = "mm", scale = 1)


# I continue with a correspondence analysis and generate an assymetric representation using 
# columns (clusters) repsented with the principal coordinates and histology classes
# represented with standard coordinates
ca.res_varsel <- ca(table_hist_clust_res_varsel)
tiff(filename = "figures/Fig26.tiff", width = 200, height = 200, units = "mm", res = 300)
plot(ca.res_varsel, map= "colprincipal") 
fig <- dev.off()
plot(ca.res_varsel, map= "colprincipal") 

# From CA analisis I get number of clusters with the greatest inertias to further compare cluster characteristics
clust_top_inertias <- data.frame(clust = ca.res_varsel$colnames, inertia = get_ca_col(ca.res_varsel)$inertia) %>% arrange(desc(inertia)) %>% top_n(3)

# After evaluating main clusters associated with different histology classes we can focus our analysis in 
# describing differences between these clusters:
lung_data_res_varsel_selected <- lung_data_res_varsel %>% filter(partition %in% clust_top_inertias$clust) %>% droplevels()
lung_data_res_varsel_selected_table <- table(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition)


# I evaluate agreement using adjusted rand index (ARI) coefficient
cat('ARI (Histology class, Partitions):',ARI(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition))


# I repeat a chi2 test just with this clusters
chisq.test(lung_data_res_varsel_selected_table) 


# And I generate a cross table focusing on these clusters
(crosstab1<- crosstable(lung_data_res_varsel_selected %>% select(.,-c(deadstatus.event,Survival.time)), 
           by = partition, test = TRUE)) 

 (table23 <- crosstab1 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table23 %>% save_kable("tables/table23.png")
```



Finally I want to analyze survival probabilities among different clusters.


```{r,fig.width=8, fig.height=8}
# I generate a specific dataframe including survival, dead status event and partition variables
df_surv_res_varsel <- data.frame(Survival.time = lung_data_no_out$Survival.time, 
                                  deadstatus.event = lung_data_no_out$deadstatus.event,
                         partition = res_varsel@partitions@zMAP)

# I create a survival object, and use it as response variable 
# to create Kaplan-Meier survival curves for each cluster
sfit_res_varsel <- survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
                            data = df_surv_res_varsel)

# I plot survival curve including confidence intervals for each curve and 
# p value result from log-rank test to evaluate difference in survival between groups
tiff(filename = "figures/Fig27.tiff", width = 300, height = 200, units = "mm", res = 300)
(surv <- ggsurvplot(sfit_res_varsel, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))
fig <- dev.off()
(surv <- ggsurvplot(sfit_res_varsel, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))

min_max_surv <- surv_median(sfit_res_varsel) %>% 
  filter(median == min(median) | median == max(median)) %>% 
  select(strata) %>% 
  separate(strata,
            into = c('string', 
                    'partition_num'),
            sep = "=",
            convert = TRUE) 
min_max_surv$partition_num
```



```{r}
# I repeat log-rank test comparing only the two most extreme median survival groups 
surv_pvalue(
  survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
          data = df_surv_res_varsel %>% filter(partition %in% min_max_surv$partition_num)),
  method = "survdiff",
  test.for.trend = FALSE,
  combine = FALSE
)


# And describe composition for the clusters with most extreme results on survival analisis
crosstab2<- crosstable(lung_data_res_varsel %>% filter(partition %in% min_max_surv$partition_num) %>% select(.,-c(deadstatus.event,Survival.time)) %>% droplevels(), 
           by = partition, test = TRUE)

 (table24 <- crosstab2 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table24 %>% save_kable("tables/table24.png")
```

            

##### Data PCA Radiomics



```{r, fig.width=8, fig.height=6}
set.seed(12345)

# I adjust VarSelCluster model without variables selection for this first
# approach and using BIC criteria to estimate the number of partitions
res_varsel_pca <- VarSelCluster(x = lung_data_pca_scaled_radiomics,
                          gvals = 2:10, 
                          nbcores = 4, 
                          vbleSelec = TRUE,  
                          crit.varsel = "BIC")

# I check the resulting model summary
summary(res_varsel_pca)
res_varsel_pca@model

# I check the discriminative power of the variables 
tiff(filename = "figures/Fig28.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel_pca)
fig <- dev.off()
plot(res_varsel_pca)


# I build q data frame including partitions, variables used in the model and other variables of interest
lung_data_res_varsel_pca <- lung_data_pca_scaled_radiomics %>% 
                              cbind(lung_data_no_out %>% select(Histology,
                                                                Survival.time,
                                                                deadstatus.event,
                                                                Manufacturer),
                                    partition = as.factor(res_varsel_pca@partitions@zMAP))


# I generate a representation of the clusters using the main discriminative variables to define the axes
# (screencapture saved as figure 29)
plot_ly(lung_data_res_varsel_pca, x=~PC1, y=~PC2,
        z=~PC3, color=~partition) %>%
        add_markers(size=1.5)%>%
        layout(
          scene = list(
            xaxis = list(size = 0.5),
            yaxis = list(size = 0.5),
            zaxis = list(size = 0.5)))


# I display a summary of the probabilities of missclassification for each cluster
tiff(filename = "figures/Fig30.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel_pca, type="probs-class")
fig <- dev.off()
plot(res_varsel_pca, type="probs-class")
```


Then I want to evaluate possible relationship between clusters generated and histology class.


```{r}
# I generate a cross table to check distribution of histology classes with partitions
table_hist_clust_res_varsel_pca <- table(lung_data_res_varsel_pca$Histology,lung_data_res_varsel_pca$partition)
addmargins(table_hist_clust_res_varsel_pca)


# I evaluate general association between clusters and histology class using chi 2 test
chisq.test(table_hist_clust_res_varsel_pca) 


# I display distribution of histology class within different clusters
ggplot(lung_data_res_varsel_pca,aes(partition, fill = Histology)) + 
  geom_bar(position = 'fill',alpha = .5) +
  coord_flip()+
  theme_bw() 
ggsave("figures/Fig31.tiff",width = 100, height = 50, device="tiff", dpi=300, units = "mm", scale = 1)


# I continue with a correspondence analysis and generate an assymetric representation using 
# columns (clusters) repsented with the principal coordinates and histology classes
# represented with standard coordinates
ca.res_varsel_pca <- ca(table_hist_clust_res_varsel_pca)
tiff(filename = "figures/Fig32.tiff", width = 200, height = 200, units = "mm", res = 300)
plot(ca.res_varsel_pca, map= "colprincipal") 
fig <- dev.off()
plot(ca.res_varsel_pca, map= "colprincipal") 

# From CA analisis I get number of clusters with the greatest inertias to further compare cluster characteristics
clust_top_inertias <- data.frame(clust = ca.res_varsel_pca$colnames, inertia = get_ca_col(ca.res_varsel_pca)$inertia) %>% arrange(desc(inertia)) %>% top_n(3)

# After evaluating main clusters associated with different histology classes we can focus our analysis in 
# describing differences between these clusters:
lung_data_res_varsel_selected <- lung_data_res_varsel_pca %>% filter(partition %in% clust_top_inertias$clust) %>% droplevels()
lung_data_res_varsel_selected_table <- table(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition)



# I evaluate agreement using adjusted rand index (ARI) coefficient
cat('ARI (Histology class, Partitions):',ARI(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition))


# I repeat a chi2 test just with this clusters
chisq.test(lung_data_res_varsel_selected_table) 


# And I generate a cross table focusing on these clusters
crosstab3<- crosstable(lung_data_res_varsel_selected %>% select(.,-c(deadstatus.event,Survival.time)), 
           by = partition, test = TRUE) 

 (table25 <- crosstab3 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table25 %>% save_kable("tables/table25.png")
```



Finally I want to analyze survival probabilities among different clusters.


```{r,fig.width=8, fig.height=8}
# I generate a specific dataframe including survival, dead status event and partition variables
df_surv_res_varsel_pca <- data.frame(Survival.time = lung_data_no_out$Survival.time, 
                                  deadstatus.event = lung_data_no_out$deadstatus.event,
                         partition = res_varsel_pca@partitions@zMAP)

# I create a survival object, and use it as response variable 
# to create Kaplan-Meier survival curves for each cluster
sfit_res_varsel_pca <- survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
                            data = df_surv_res_varsel_pca)

# I plot survival curve including confidence intervals for each curve and 
# p value result from log-rank test to evaluate difference in survival between groups
tiff(filename = "figures/Fig33.tiff", width = 300, height = 200, units = "mm", res = 300)
(surv <- ggsurvplot(sfit_res_varsel_pca, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))
fig <- dev.off()
(surv <- ggsurvplot(sfit_res_varsel_pca, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))

min_max_surv <- surv_median(sfit_res_varsel_pca) %>% 
  filter(median == min(median) | median == max(median)) %>% 
  select(strata) %>% 
  separate(strata,
            into = c('string', 
                    'partition_num'),
            sep = "=",
            convert = TRUE) 
min_max_surv$partition_num
```



```{r}
# I repeat log-rank test comparing only the two most extreme median survival groups 
surv_pvalue(
  survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
          data = df_surv_res_varsel_pca %>% filter(partition %in% min_max_surv$partition_num)),
  method = "survdiff",
  test.for.trend = FALSE,
  combine = FALSE
)


# And describe composition for the clusters with most extreme results on survival analisis
crosstab4<- crosstable(lung_data_res_varsel_pca %>% filter(partition %in% min_max_surv$partition_num) %>% select(.,-c(deadstatus.event,Survival.time)) %>% droplevels(), 
           by = partition, test = TRUE)

 (table26 <- crosstab4 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table26 %>% save_kable("tables/table26.png")
```



#### Without additional variable selection


##### Data MRMR filtered Radiomics


I generate the model:

```{r, fig.width=8, fig.height=6}
# I adjust VarSelCluster model without variables selection for this first
# approach and using BIC criteria to estimate the optimal number of clusters
set.seed(12345)
res_varsel <- VarSelCluster(x = lung_data_filtered_scaled_radiomics,
                          gvals = 2:10, 
                          nbcores = 4, 
                          vbleSelec = FALSE,  
                          crit.varsel = "BIC")

# I check the resulting model summary
summary(res_varsel)
res_varsel@model@names.relevant
res_varsel@model@names.irrelevant

# I check the discriminative power of the variables 
tiff(filename = "figures/Fig34.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel)
fig <- dev.off()
plot(res_varsel)


# I build q data frame including partitions, variables used in the model and other variables of interest
lung_data_res_varsel <- lung_data_filtered_scaled_radiomics %>% 
                              cbind(lung_data_no_out %>% select(Histology,
                                                                Survival.time,
                                                                deadstatus.event,
                                                                Manufacturer),
                                    partition = as.factor(res_varsel@partitions@zMAP))


# I generate a representation of the clusters using the main discriminative variables to define the axes
# (screencapture saved as figure 35)
plot_ly(lung_data_res_varsel, x=~original_shape_VoxelVolume, y=~wavelet.HLL_glszm_LargeAreaHighGrayLevelEmphasis,
        z=~wavelet.HHH_glszm_LargeAreaLowGrayLevelEmphasis, color=~partition) %>%
        add_markers(size=1.5)%>%
        layout(
          scene = list(
            xaxis = list(size = 0.5),
            yaxis = list(size = 0.5),
            zaxis = list(size = 0.5)))


# I display a summary of the probabilities of missclassification for each cluster
tiff(filename = "figures/Fig36.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel, type="probs-class")
fig <- dev.off()
plot(res_varsel, type="probs-class")
```


Then I want to evaluate possible relationship between clusters generated and histology class.


```{r}
# I generate a cross table to check distribution of histology classes with partitions
table_hist_clust_res_varsel <- table(lung_data_res_varsel$Histology,lung_data_res_varsel$partition)
addmargins(table_hist_clust_res_varsel)


# I evaluate general association between clusters and histology class using chi 2 test
chisq.test(table_hist_clust_res_varsel) 


# I display distribution of histology class within different clusters
ggplot(lung_data_res_varsel,aes(partition, fill = Histology)) + 
  geom_bar(position = 'fill',alpha = .5) +
  coord_flip()+
  theme_bw() 
ggsave("figures/Fig37.tiff",width = 100, height = 50, device="tiff", dpi=300, units = "mm", scale = 1)


# I continue with a correspondence analysis and generate an assymetric representation using 
# columns (clusters) repsented with the principal coordinates and histology classes
# represented with standard coordinates
ca.res_varsel <- ca(table_hist_clust_res_varsel)
tiff(filename = "figures/Fig38.tiff", width = 200, height = 200, units = "mm", res = 300)
plot(ca.res_varsel, map= "colprincipal") 
fig <- dev.off()
plot(ca.res_varsel, map= "colprincipal") 

# From CA analisis I get number of clusters with the greatest inertias to further compare cluster characteristics
clust_top_inertias <- data.frame(clust = ca.res_varsel$colnames, inertia = get_ca_col(ca.res_varsel)$inertia) %>% arrange(desc(inertia)) %>% top_n(3)

# After evaluating main clusters associated with different histology classes we can focus our analysis in 
# describing differences between these clusters:
lung_data_res_varsel_selected <- lung_data_res_varsel %>% filter(partition %in% clust_top_inertias$clust) %>% droplevels()
lung_data_res_varsel_selected_table <- table(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition)

# I evaluate agreement using adjusted rand index (ARI) coefficient
cat('ARI (Histology class, Partitions):',ARI(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition))


# I repeat a chi2 test just with this clusters
chisq.test(lung_data_res_varsel_selected_table) 


# And I generate a cross table focusing on these clusters
crosstab5<- crosstable(lung_data_res_varsel_selected %>% select(.,-c(deadstatus.event,Survival.time)), 
           by = partition, test = TRUE)

 (table27 <- crosstab5 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table27 %>% save_kable("tables/table27.png")
```



Finally I want to analyze survival probabilities among different clusters.


```{r,fig.width=8, fig.height=8}
# I generate a specific dataframe including survival, dead status event and partition variables
df_surv_res_varsel <- data.frame(Survival.time = lung_data_no_out$Survival.time, 
                                  deadstatus.event = lung_data_no_out$deadstatus.event,
                         partition = res_varsel@partitions@zMAP)

# I create a survival object, and use it as response variable 
# to create Kaplan-Meier survival curves for each cluster
sfit_res_varsel <- survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
                            data = df_surv_res_varsel)

# I plot survival curve including confidence intervals for each curve and 
# p value result from log-rank test to evaluate difference in survival between groups
tiff(filename = "figures/Fig39.tiff", width = 300, height = 200, units = "mm", res = 300)
(surv <- ggsurvplot(sfit_res_varsel, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))
fig <- dev.off()
(surv <- ggsurvplot(sfit_res_varsel, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))

min_max_surv <- surv_median(sfit_res_varsel) %>% 
  filter(median == min(median) | median == max(median)) %>% 
  select(strata) %>% 
  separate(strata,
            into = c('string', 
                    'partition_num'),
            sep = "=",
            convert = TRUE) 
min_max_surv$partition_num
```



```{r}
# I repeat log-rank test comparing only the two most extreme median survival groups 
surv_pvalue(
  survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
          data = df_surv_res_varsel %>% filter(partition %in% min_max_surv$partition_num)),
  method = "survdiff",
  test.for.trend = FALSE,
  combine = FALSE
)


# And describe composition for the clusters with most extreme results on survival analisis
crosstab6<- crosstable(lung_data_res_varsel %>% filter(partition %in% min_max_surv$partition_num) %>% select(.,-c(deadstatus.event,Survival.time)) %>% droplevels(), 
           by = partition, test = TRUE) 

 (table28 <- crosstab6 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table28 %>% save_kable("tables/table28.png")
```

            

##### Data PCA Radiomics



```{r, fig.width=8, fig.height=6}
set.seed(12345)

# I adjust VarSelCluster model without variables selection for this first
# approach and using BIC criteria to estimate the number of partitions
res_varsel_pca <- VarSelCluster(x = lung_data_pca_scaled_radiomics,
                          gvals = 2:10, 
                          nbcores = 4, 
                          vbleSelec = FALSE,  
                          crit.varsel = "BIC")

# I check the resulting model summary
summary(res_varsel_pca)
res_varsel_pca@model

# I check the discriminative power of the variables 
tiff(filename = "figures/Fig40.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel_pca)
fig <- dev.off()
plot(res_varsel_pca)


# I build q data frame including partitions, variables used in the model and other variables of interest
lung_data_res_varsel_pca <- lung_data_pca_scaled_radiomics %>% 
                              cbind(lung_data_no_out %>% select(Histology,
                                                                Survival.time,
                                                                deadstatus.event,
                                                                Manufacturer),
                                    partition = as.factor(res_varsel_pca@partitions@zMAP))


# I generate a representation of the clusters using the main discriminative variables to define the axes
# (screencapture saved as figure 41)
plot_ly(lung_data_res_varsel_pca, x=~PC1, y=~PC2,
        z=~PC3, color=~partition) %>%
        add_markers(size=1.5)%>%
        layout(
          scene = list(
            xaxis = list(size = 0.5),
            yaxis = list(size = 0.5),
            zaxis = list(size = 0.5)))


# I display a summary of the probabilities of missclassification for each cluster
tiff(filename = "figures/Fig42.tiff", width = 400, height = 150, units = "mm", res = 300)
plot(res_varsel_pca, type="probs-class")
fig <- dev.off()
plot(res_varsel_pca, type="probs-class")
```


Then I want to evaluate possible relationship between clusters generated and histology class.


```{r}
# I generate a cross table to check distribution of histology classes with partitions
table_hist_clust_res_varsel_pca <- table(lung_data_res_varsel_pca$Histology,lung_data_res_varsel_pca$partition)
addmargins(table_hist_clust_res_varsel_pca)


# I evaluate general association between clusters and histology class using chi 2 test
chisq.test(table_hist_clust_res_varsel_pca) 


# I display distribution of histology class within different clusters
ggplot(lung_data_res_varsel_pca,aes(partition, fill = Histology)) + 
  geom_bar(position = 'fill',alpha = .5) +
  coord_flip()+
  theme_bw() 
ggsave("figures/Fig43.tiff",width = 100, height = 50, device="tiff", dpi=300, units = "mm", scale = 1)


# I continue with a correspondence analysis and generate an assymetric representation using 
# columns (clusters) repsented with the principal coordinates and histology classes
# represented with standard coordinates
ca.res_varsel_pca <- ca(table_hist_clust_res_varsel_pca)
tiff(filename = "figures/Fig44.tiff", width = 200, height = 200, units = "mm", res = 300)
plot(ca.res_varsel_pca, map= "colprincipal") 
fig <- dev.off()
plot(ca.res_varsel_pca, map= "colprincipal") 

# From CA analisis I get number of clusters with the greatest inertias to further compare cluster characteristics
clust_top_inertias <- data.frame(clust = ca.res_varsel_pca$colnames, inertia = get_ca_col(ca.res_varsel_pca)$inertia) %>% arrange(desc(inertia)) %>% top_n(3)

# After evaluating main clusters associated with different histology classes we can focus our analysis in 
# describing differences between these clusters:
lung_data_res_varsel_selected <- lung_data_res_varsel_pca %>% filter(partition %in% clust_top_inertias$clust) %>% droplevels()
lung_data_res_varsel_selected_table <- table(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition)


# I evaluate agreement using adjusted rand index (ARI) coefficient
cat('ARI (Histology class, Partitions):',ARI(lung_data_res_varsel_selected$Histology,lung_data_res_varsel_selected$partition))


# I repeat a chi2 test just with this clusters
chisq.test(lung_data_res_varsel_selected_table) 


# And I generate a cross table focusing on these clusters
crosstab7<- crosstable(lung_data_res_varsel_selected %>% select(.,-c(deadstatus.event,Survival.time)), 
           by = partition, test = TRUE)

 (table29 <- crosstab7 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table29 %>% save_kable("tables/table29.png")
```



Finally I want to analyze survival probabilities among different clusters.


```{r,fig.width=8, fig.height=8}
# I generate a specific dataframe including survival, dead status event and partition variables
df_surv_res_varsel_pca <- data.frame(Survival.time = lung_data_no_out$Survival.time, 
                                  deadstatus.event = lung_data_no_out$deadstatus.event,
                         partition = res_varsel_pca@partitions@zMAP)

# I create a survival object, and use it as response variable 
# to create Kaplan-Meier survival curves for each cluster
sfit_res_varsel_pca <- survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
                            data = df_surv_res_varsel_pca)

# I plot survival curve including confidence intervals for each curve and 
# p value result from log-rank test to evaluate difference in survival between groups
tiff(filename = "figures/Fig45.tiff", width = 300, height = 200, units = "mm", res = 300)
(surv <- ggsurvplot(sfit_res_varsel_pca, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))
fig <- dev.off()
(surv <- ggsurvplot(sfit_res_varsel_pca, 
           surv.median.line = 'hv',
           pval=TRUE, 
           risk.table='percentage',
           surv.plot.height = 0.7,
           tables.height = 0.3))

min_max_surv <- surv_median(sfit_res_varsel_pca) %>% 
  filter(median == min(median) | median == max(median)) %>% 
  select(strata) %>% 
  separate(strata,
            into = c('string', 
                    'partition_num'),
            sep = "=",
            convert = TRUE) 
min_max_surv$partition_num
```



```{r}
# I repeat log-rank test comparing only the two most extreme median survival groups 
surv_pvalue(
  survfit(Surv(Survival.time, as.numeric(deadstatus.event)) ~ partition, 
          data = df_surv_res_varsel_pca %>% filter(partition %in% min_max_surv$partition_num)),
  method = "survdiff",
  test.for.trend = FALSE,
  combine = FALSE
)


# And describe composition for the clusters with most extreme results on survival analisis
crosstab8<- crosstable(lung_data_res_varsel_pca %>% filter(partition %in% min_max_surv$partition_num) %>% select(.,-c(deadstatus.event,Survival.time)) %>% droplevels(), 
           by = partition, test = TRUE)

 (table30 <- crosstab8 %>% separate(test,
            into = c('pvalue', 
                    'test'),
            sep = "\n") %>% 
            separate(pvalue,
            into = c('string', 
                    'pval'),
            sep = ":",
            convert = TRUE) %>% 
            arrange(pval) %>% 
            filter(variable != 'Med [IQR]',
                   variable != 'N (NA)',
                   variable != 'Min / Max') %>% 
            dplyr::select(.,-c(string,.id)) %>% kable(full_with = FALSE) %>% kable_classic_2())

 
 table30 %>% save_kable("tables/table30.png")
```




